---
title: "COVID-JHEEM Results Summary"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
df = read.csv('../results/jheem_covid_3.0_results.csv', stringsAsFactors = F)
source('../make_covid_figures_and_tables.R')
source('../covid_timeline_plot.R')
msas = as.character(unique(df$msa))
msa.names = as.character(sapply(msas, function(msa){df$msa.name[df$msa==msa][1]}))
names(msa.names) = msas

ALPHA = 0.7
POINT.SIZE = 3

MIN.CHANGE = -0.25
MAX.CHANGE = 0.25
CHANGE.YEARS = 2020:2025
```


In our model simulations, we represented the effects on HIV epidemiology of the COVID-19 pandemic and attendant lockdowns via four parameters in our model:
\begin{enumerate}
    \item The rate of sexual transmission of HIV
    \item The rate of testing for HIV
    \item The proportion of PWH (aware of their status) who are virally suppressed
    \item The proportion of the HIV-uninfected at risk for HIV acquisition who are enrolled in a PrEP program
\end{enumerate}
We framed each of these four parameters as a multiplier relative to what the level in each stratum of age/race/sex/risk factor would have been absent the pandemic. For example, if for a given simulation, the multiplier for rate of testing was 0.75, then at for each of the 135 strata of age/race/sex/risk factor, the rate of testing was three-quarters of what it otherwise would have been at that time.

We ran simulations under four different scenarios, each with a different timeline over which the changes to sexual transmission, HIV testing, viral suppression, and PrEP apply. In each scenario, reductions in each parameter begin on March 1, 2020.
\begin{enumerate}
    \item Our \underline{Base COVID Scenario} posits that reductions in all four parameters continue through March 8, 2021, and linearly return to normal from March 8, 2021 to July 4, 2021.
    \item Our \underline{COVID with Delayed Resumption of HIV Screening, Viral Suppression, and PrEP} posits that reductions in sexual transmission continue through March 8, 2021 and return to normal by July 4, 2021 as in the base COVID scenario, but normalization of reductions in HIV testing, viral suppression, and PrEP lag by six months (ie, they begin to normalize on Sept 8, 2021, and do not fully normalize until Feb 4, 2022).
    \item Our \underline{Rebound Increase in Sexual Transmission} scenario posits that sexual transmission continues at a reduced level until March 8, 2021, but from March 8, 2021 to July 4, 2021, increases to a level ABOVE what it would have been absent the pandemic. The rate of sexual transmission decreases (linearly) back to normal from July 4, 2021 to Feb 4, 2022. HIV testing, viral suppression, and PrEP use follow the trajectory laid out in base COVID scenario (are reduced until Jan 1, 2021, and normalize from March 8, 2021 to July 4, 2021).
    \item Our \underline{Rebound Increase in Sexual Transmission AND Delayed Resumption of HIV Care} posits that sexual transmission follows its trajectory from the Rebound Increase scenario (reduced until March 8, 2021, rising to an increased level by July 4, 2021, decreasing back to normal by Feb 4, 2021) while HIV screening, viral suppression, and PrEP use follow their trajectories from the Delayed Resumption scenario (reduced until Sept 8, 2021, normalize from sept 8, 2021 to Feb 4, 2022)
\end{enumerate}

For each of the 32 MSAs, we conducted 1,000 simulations for each scenario, for each simulation, we randomly sampled values for reductions or increases in the four parameters according to uniform distributions with the bounds given below:

\begin{center}
\begin{tabular}{ r|c|c } 
    \hline
    \hline
    \textbf{Parameter} & \textbf{Lower Bound} & \textbf{Upper Bound} \\ \hline
    \hline
    Reduction in Sexual Transmission & 0\% & 50\% \\ \hline
    Reduction in HIV Screening & 8\% & 50\% \\ \hline
    Reduction in Viral Suppression & 2.5\% & 40\% \\ \hline
    Reduction in Viral Suppression & 4\% & 30\% \\ \hline
    Rebound Increase in Sexual Transmission & 0\% & 25\% \\ \hline
    \hline
\end{tabular}
\end{center}

```{r echo=F, fig.height=7}

    print(make.covid.timeline.plot(df, aggregate.locations = T, years=2019:2025,
                                   outcomes=c('incidence','new')) +
              geom_vline(xintercept = c(2020.25, 2021, 2021 + 184/365), linetype='dotted') +
              ggtitle("Projected HIV Incidence (number of cases - summed across 4 cities)\nUnder Different Scenarios vis-a-vis COVID-19"))

    print(make.covid.timeline.plot(df, aggregate.locations = F, years=2019:2025) + 
              geom_vline(xintercept = c(2020.25, 2021, 2021 + 184/365), linetype='dotted') +
              ggtitle("Projected HIV Incidence across 4 cities (number of cases)\nUnder Different Scenarios vis-a-vis COVID-19"))

    
    print(make.covid.timeline.plot(df, outcome='incidence.rate', aggregate.locations = F, years=2019:2025, fixed.scale=T) + 
              geom_vline(xintercept = c(2020.25, 2021, 2021 + 184/365), linetype='dotted') +
              ggtitle("Projected HIV Incidence across 4 cities (per 100,000)\nUnder Different Scenarios vis-a-vis COVID-19"))
    
  #  print(make.covid.summary.table(df))
    
    for (variable in names(VARIABLE.LABELS))
        print(make.variable.vs.outcome.figure(variable=variable, df=df, 
                                              scenario='base',
                                             years=CHANGE.YEARS,
                                              alpha=ALPHA, point.size=1) +
                  ggtitle(paste0("Change in Cumulative Incidence (2020-2030) vs. Reduction in\n", VARIABLE.LABELS[variable], " (COVID: Base Case)")))
    
    
    print(make.two.variable.reduction.figure(df=df, 
                                             scenario='base',
                                             years=CHANGE.YEARS,
                                             min.change=MIN.CHANGE, max.change = MAX.CHANGE,
                                             alpha=ALPHA, point.size=POINT.SIZE) +
              ggtitle("Change in Cumulative Incidence (2020-2030) by Reductions in\nSexual Transmission and Suppression (COVID: Base Case)"))
    
    
    print(make.two.variable.reduction.figure(df=df, 
                                             scenario='delayed.hiv.care',
                                             years=CHANGE.YEARS,
                                             min.change=MIN.CHANGE, max.change = MAX.CHANGE,
                                             alpha=ALPHA, point.size=POINT.SIZE) +
              ggtitle("Change in Cumulative Incidence (2020-2030) by Reductions in\nSexual Transmission and Suppression (COVID: Delayed Resumption of HIV Care)"))
    
    
    print(make.two.variable.reduction.figure(df=df, 
                                             scenario='rebound.sexual.transmission',
                                             years=CHANGE.YEARS,
                                             min.change=MIN.CHANGE, max.change = MAX.CHANGE,
                                             variable2 = 'sexual.transmission',
                                             variable2.category = 'increase',
                                             alpha=ALPHA, point.size=POINT.SIZE) +
              ggtitle("Change in Cumulative Incidence (2020-2030) by Initial Reduction\nand Subsequent Rebound in Sexual Transmission and Suppression (COVID: Rebound Increase in Sexual Transmission)"))
    
    
    print(make.two.variable.reduction.figure(df=df, 
                                             scenario='rebound.sex.delayed.hiv.care',
                                             years=CHANGE.YEARS,
                                             min.change=MIN.CHANGE, max.change = MAX.CHANGE,
                                             variable1 = 'sexual.transmission',
                                             variable1.category = 'increase',
                                             variable2 = 'suppression',
                                             alpha=ALPHA, point.size=POINT.SIZE) +
              ggtitle("Change in Cumulative Incidence (2020-2030) by Rebound in\nSexual Transmission and Reduction in  Suppression (COVID: Rebound Sexual Transmission and Delayed HIV Care)"))
```
